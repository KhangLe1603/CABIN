<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quản lý CABIN</title>
  <style>
    :root{
      --bg:#f7f7f9; --card:#ffffff; --muted:#666; --accent:#0b5fff;
      --danger:#ff6b6b; --border:#d0d0d5; --cab-white:#ffffff; --cab-red:#ffecec;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;background:var(--bg);color:#111}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:linear-gradient(90deg,#fff,#f8fbff);box-shadow:0 1px 0 var(--border)}
    .title{font-weight:700;font-size:18px}
    .clock{font-size:14px;color:var(--muted)}
    .container{padding:18px}
    .controls{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .controls label{font-size:13px;color:var(--muted)}
    input[type=number]{width:84px;padding:6px;border:1px solid var(--border);border-radius:6px}
    button{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    button.reset{background:#ff6b6b}
    button.apply{background:#007d3a}
    table{width:100%;border-collapse:collapse;background:var(--card);border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(20,30,80,0.06)}
    th,td{padding:8px 6px;border-bottom:1px solid var(--border);text-align:center;font-size:13px;border-right:1px solid var(--border)}
    thead th{background:#fbfdff;position:sticky;top:0;z-index:2}
    .cab-row td:first-child, .cab-row th:first-child{position:sticky;left:0;background:#f9fafb;z-index:3;border-right:2px solid var(--border)}
    .cab-name{font-weight:600}
    .teacher-input{width:120px;padding:6px;border:1px solid var(--border);border-radius:6px}
    .timer{min-width:64px;padding:6px;border-radius:6px}
    .cab-white{background:var(--cab-white)}
    .cab-red{background:var(--cab-red)}
    .ending{background:var(--danger)!important;color:#fff}
    .divider-row td{border-top:3px solid #000;background:#f0f0f0;font-weight:600;text-align:left;padding:4px 10px;}
    @media (max-width:900px){
      .teacher-input{width:90px}
      th,td{padding:6px;font-size:12px}
      .controls{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Bảng quản lý CABIN</div>
    <div class="clock" id="clock">--</div>
  </div>

  <div class="container">
    <div class="controls">
      <label>Thời lượng ca (phút): <input id="shiftDuration" type="number" value="120" min="1"></label>
      <label>Cảnh báo khi còn (phút): <input id="warnMinutes" type="number" value="10" min="0"></label>
      <button id="applyBtn" class="apply">Áp dụng</button>
      <button id="resetBtn" class="reset">Reset toàn bộ</button>
      <div style="margin-left:auto;color:var(--muted);font-size:13px">11 CABIN trắng — 2 CABIN đỏ • Các ca: 08:00,10:00,12:00,14:00,18:00</div>
    </div>

    <div style="overflow:auto">
      <table id="cabTable">
        <thead>
          <tr>
            <th>Cabin</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const cabins = [];
    for(let i=1;i<=11;i++) cabins.push({name:"CABIN "+i, color:'white'});
    cabins.push({name:'CABIN 12', color:'red'});
    cabins.push({name:'CABIN 13', color:'red'});

    const shifts = ['08:00','10:00','12:00','14:00','18:00'];
    const state = {};
    const table = document.getElementById('cabTable');
    const tbody = table.querySelector('tbody');
    const theadRow = table.querySelector('thead tr');
    const shiftDurationInput = document.getElementById('shiftDuration');
    const warnMinutesInput = document.getElementById('warnMinutes');
    const applyBtn = document.getElementById('applyBtn');
    const resetBtn = document.getElementById('resetBtn');

    // Load cache
    const cached = JSON.parse(localStorage.getItem('cabinState')||'{}');
    const cachedConfig = JSON.parse(localStorage.getItem('cabinConfig')||'{}');
    if(cachedConfig.shiftDuration) shiftDurationInput.value = cachedConfig.shiftDuration;
    if(cachedConfig.warnMinutes) warnMinutesInput.value = cachedConfig.warnMinutes;

    // Header rendering
    shifts.forEach(shift=>{
      const th = document.createElement('th');
      th.colSpan = 2;
      th.innerHTML = `<div style="font-weight:700">${shift}</div><div style="font-size:12px;color:var(--muted)">Giáo viên / Thời gian</div>`;
      theadRow.appendChild(th);
    });

    function makeRow(c,i){
      const tr = document.createElement('tr');
      tr.className = 'cab-row';
      const firstTd = document.createElement('td');
      firstTd.innerHTML = `<div class="cab-name">${c.name}</div><div style="font-size:12px;color:var(--muted)">${c.color==='red'? 'CABIN đỏ':'CABIN trắng'}</div>`;
      firstTd.style.minWidth='140px';
      tr.appendChild(firstTd);

      shifts.forEach((shift,j)=>{
        const tdTeacher = document.createElement('td');
        const input = document.createElement('input');
        input.className='teacher-input'; input.placeholder='Nhập tên giáo viên'; input.dataset.key=`${i}-${j}`;
        tdTeacher.appendChild(input);
        tr.appendChild(tdTeacher);

        const tdTimer = document.createElement('td');
        tdTimer.className='timer '+(c.color==='red'?'cab-red':'cab-white');
        tdTimer.dataset.key=`${i}-${j}`;
        tdTimer.textContent='00:00:00';
        tr.appendChild(tdTimer);

        state[`${i}-${j}`] = {start:null, running:false, intervalId:null};

        input.addEventListener('input', e=>{
          const key = e.target.dataset.key;
          if(e.target.value.trim()!=='') startTimer(key); else resetCell(key);
          saveCache();
        });
      });
      return tr;
    }

    cabins.forEach((c,i)=>{
      if(i===11){ // separator before red cabins
        const divRow=document.createElement('tr');
        divRow.className='divider-row';
        const td=document.createElement('td');
        td.colSpan=shifts.length*2+1;
        td.textContent='CABIN ĐỎ';
        divRow.appendChild(td);
        tbody.appendChild(divRow);
      }
      tbody.appendChild(makeRow(c,i));
    });

    // Restore cache if any
    if(cached){
      Object.keys(cached).forEach(k=>{
        const data=cached[k];
        const input=document.querySelector(`input[data-key='${k}']`);
        const timer=document.querySelector(`td.timer[data-key='${k}']`);
        if(input && data.teacher) input.value=data.teacher;
        if(data.start && data.running){
          state[k].start=data.start; state[k].running=data.running;
          startTimer(k,true);
        }
        if(timer && data.time) timer.textContent=data.time;
      });
    }

    function updateClock(){
      const now=new Date();
      document.getElementById('clock').textContent=now.toLocaleString('vi-VN',{weekday:'long',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }
    updateClock(); setInterval(updateClock,1000);

    function formatHMS(seconds){const h=Math.floor(seconds/3600),m=Math.floor((seconds%3600)/60),s=Math.floor(seconds%60);return[h,m,s].map(v=>String(v).padStart(2,'0')).join(':');}

    function startTimer(key,resume=false){
      const entry=state[key]; if(!entry) return;
      if(!resume && entry.running) return;
      if(!resume) entry.start=Date.now(); entry.running=true;
      const dur=parseInt(shiftDurationInput.value,10)||120; const warn=parseInt(warnMinutesInput.value,10)||10;
      const durSec=dur*60, warnSec=warn*60;
      clearInterval(entry.intervalId);
      const tick=()=>{
        const elapsed=Math.floor((Date.now()-entry.start)/1000);
        const remain=Math.max(0,durSec-elapsed);
        const el=document.querySelector(`td.timer[data-key='${key}']`);
        if(el){el.textContent=formatHMS(elapsed); el.classList.toggle('ending',remain<=warnSec);}
        if(remain<=0){clearInterval(entry.intervalId); entry.running=false;}
        saveCache();
      };
      tick(); entry.intervalId=setInterval(tick,1000);
    }

    function resetCell(key){
      const e=state[key]; if(!e) return; clearInterval(e.intervalId); e.start=null; e.running=false;
      const el=document.querySelector(`td.timer[data-key='${key}']`); if(el){el.textContent='00:00:00'; el.classList.remove('ending');}
      const inp=document.querySelector(`input[data-key='${key}']`); if(inp) inp.value='';
      saveCache();
    }

    resetBtn.addEventListener('click',()=>{
      Object.keys(state).forEach(k=>resetCell(k)); localStorage.clear();
    });

    applyBtn.addEventListener('click',()=>{
      saveConfig(); Object.keys(state).forEach(k=>{if(state[k].running) startTimer(k,true);});
    });

    function saveCache(){
      const obj={}; Object.keys(state).forEach(k=>{
        const inp=document.querySelector(`input[data-key='${k}']`);
        const timer=document.querySelector(`td.timer[data-key='${k}']`);
        obj[k]={teacher:inp?inp.value:'',start:state[k].start,running:state[k].running,time:timer?timer.textContent:''};
      });
      localStorage.setItem('cabinState',JSON.stringify(obj));
    }
    function saveConfig(){
      localStorage.setItem('cabinConfig',JSON.stringify({shiftDuration:shiftDurationInput.value,warnMinutes:warnMinutesInput.value}));
    }
  </script>
</body>
</html>
